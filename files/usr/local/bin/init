#!/bin/sh

#
# (Re-)Configures Apache, PHP and XDebug and runs
# what was given as command line arguments
#

# Use the same environment as during build
. /etc/environment

# Use specified timezone, if any
if [ -n "$TIMEZONE" -a -f "/usr/share/zoneinfo/${TIMEZONE}" ]; then
	cp /usr/share/zoneinfo/${TIMEZONE} /etc/localtime
	echo "Timezone: $TIMEZONE"
fi

# Set up developer/XDebug/production mode
case "$MODE" in
	dev|DEV)
		echo "Developer mode"
		MODE=dev
        XDEBUG=
		;;

    xdebug|XDEBUG)
		echo "Developer mode with XDebug"
		MODE=dev
        XDEBUG=y
		;;

	prod|PROD|'')
		echo "Production mode"
		MODE=prod
        XDEBUG=
		;;

	*)
		echo "Unknown mode: $MODE. Defaulting to production mode"
		MODE=prod
		;;
esac

ln -sf /etc/apache2/conf.d/mode.conf.${MODE} /etc/apache2/conf.d/mode.conf
ln -sf /etc/php7/mode.${MODE}.template /etc/php7/conf.d/zz_50_mode.ini

# php.ini setting overrides
export \
    | awk -F ' |=' \
        -e 'BEGIN { IGNORECASE = 1 }' \
        -e '$2 ~ /^PHP_/ { gsub("^PHP_", "", $2); gsub(/'"'"'/, "", $3); printf "%s=%s\n", $2, $3; }' \
    > /etc/php7/conf.d/zz_99_overrides.ini

if [ -s /etc/php7/conf.d/zz_99_overrides.ini ]; then
	echo "Overriding these php.ini settings:"
	cat /etc/php7/conf.d/zz_99_overrides.ini | sed 's/\(.*\)/  \1/'
fi

# Enable/disable XDebug support
if [ -n "$XDEBUG" ]; then
    # Connect back only if host IP not specified
    export REMOTE_HOST=$HOST_IP
    test -n "$HOST_IP"
    export REMOTE_CONNECT_BACK=$?

	cat /etc/php7/xdebug.ini.template | envsubst > /etc/php7/conf.d/xdebug.ini
	echo "XDebug enabled:"
    grep -E '^xdebug\.remote_(host|connect_back)=' /etc/php7/conf.d/xdebug.ini \
        | sed 's/\(.*\)/  \1/'

else
	truncate -s 0 /etc/php7/conf.d/xdebug.ini
	echo "XDebug disabled"
fi

# root created missing paths for volumes also in $APACHE_HOME, therefore:
chown -R apache:apache $APACHE_HOME 

# Clean up Apache PID files only if this is the initial process
[ $$ -eq 1 ] && rm -f /run/apache2/apache2.pid /run/apache2/httpd.pid

# Execute Dockerfile CMD or command line
echo "Executing '$@', PID = $$"
$@
